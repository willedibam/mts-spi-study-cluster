#!/bin/bash
#PBS -N spi_array_full_asym
#PBS -l select=1:ncpus=8:mem=32gb
#PBS -l walltime=48:00:00
#PBS -J 1-180
#PBS -m bea
#PBS -M wedi0306@uni.sydney.edu.au

set -euo pipefail

if [[ -z "${PBS_O_WORKDIR:-}" ]]; then
  echo "[ERROR] PBS_O_WORKDIR not set."
  exit 1
fi

cd "$PBS_O_WORKDIR"

LOG_DIR="$PBS_O_WORKDIR/logs"
mkdir -p "$LOG_DIR"
ARRAY_ID="${PBS_ARRAY_INDEX:-1}"
JOB_LABEL="${PBS_JOBNAME}_${ARRAY_ID}"
exec >"$LOG_DIR/${JOB_LABEL}.out" 2>"$LOG_DIR/${JOB_LABEL}.err"

module purge
source .venv/bin/activate

NUM_THREADS=${NUM_THREADS:-8}
export OMP_NUM_THREADS=$NUM_THREADS
export OPENBLAS_NUM_THREADS=$NUM_THREADS
export MKL_NUM_THREADS=$NUM_THREADS
export NUMEXPR_NUM_THREADS=$NUM_THREADS

echo "[INFO] Starting PBS array index ${ARRAY_ID} at $(date)"
python -m src.run_experiments \
  --mode full \
  --job-index "${ARRAY_ID}" \
  --regenerate-timeseries \
  --experiment-config configs/experiments_full_3.yaml \
  --pyspi-config configs/blended_sonnet_config.yaml \
  --threads "${NUM_THREADS}" \
  --heatmap \
  --parquet
echo "[INFO] Finished at $(date)"
